name: Release default
on:
  workflow_dispatch:
    inputs:
      main_checkmark:
        description: 'Build from main branches'
        default: false
        type: boolean
        required: true
      release_version:
        description: 'Enter the release version (e.g. v1.2.3)'
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout origin (ci-cd-main) repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ensures all branches and history are fetched

      - name: Set up branches based on checkmark input
        id: set_branches
        run: |
          echo "Validating checkmark set"
          if [ "${{ github.event.inputs.main_checkmark }}" == "true" ]; then
            echo "Building from main branches"
            echo "CLIENT1_BRANCH=main" >> $GITHUB_ENV
            echo "CLIENT2_BRANCH=main" >> $GITHUB_ENV
            echo "RELEASE_BRANCH=main" >> $GITHUB_ENV
          else
            echo "Error: checkmark was not set"
            exit 1
          fi

      - name: Checkout submodule client1
        uses: actions/checkout@v4
        with:
          token: '${{ secrets.GITHUB_TOKEN }}'
          repository: illyazhuk/client1
          path: default/procentric/app/client1
          ref: ${{ env.CLIENT1_BRANCH }}

      - name: Checkout submodule client2
        uses: actions/checkout@v4
        with:
          token: '${{ secrets.GITHUB_TOKEN }}'
          repository: illyazhuk/client2
          path: default/remote/client2
          ref: ${{ env.CLIENT2_BRANCH }}

      - name: Checkout to a new branch
        run: |
          echo "Configuring branch on origin repository"
          if [[ "${{ env.RELEASE_BRANCH }}" == "main" ]] || [[ "${{ env.RELEASE_BRANCH }}" == "master" ]]; then
            echo "Skip checkout for main/master branch"

          elif git ls-remote --heads origin "${{ env.RELEASE_BRANCH }}" | grep -q "${{ env.RELEASE_BRANCH }}"; then
            echo "Error: ${{ env.RELEASE_BRANCH }} already exists on Remote"
            exit 1

          else
            echo "Switching to a new branch ${{ env.RELEASE_BRANCH }}"
            git checkout -b ${{ env.RELEASE_BRANCH }}
          fi

      - name: Commit updated submodule pointers
        run: |
          echo "Configuring user for a commit"
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          echo "Check difference in submodule pointers"
          git diff
          echo "Adding updated code"
          git add .
          echo "Creating commit with updates for submodules"
          git diff-index --quiet HEAD || git commit -m "Update submodules to latest branches"

      - name: Push changes to target branch
        run: |
          echo "Validating possibility to push changes to target branch"
          if [[ "${{ env.RELEASE_BRANCH }}" == "main" ]] || [[ "${{ env.RELEASE_BRANCH }}" == "master" ]]; then
            echo "Target branch is main - Push updated state"
            git push

          else
            echo "Ensure target branch would not be overwritten"
            if git ls-remote --heads origin "${{ env.RELEASE_BRANCH }}" | grep -q "${{ env.RELEASE_BRANCH }}"; then
              echo "Branch already exists on remote, not pushing."
              exit 1

            else
              echo "Create upstream to a new target branch"
              git push --set-upstream origin ${{ env.RELEASE_BRANCH }}
            fi
          fi

      - name: Auto-increment the release version and push the release tag
        id: increment_version
        run: |
          echo "Configuring release tag"
          if [[ "${{ env.RELEASE_BRANCH }}" == "main" ]] || [[ "${{ env.RELEASE_BRANCH }}" == "master" ]]; then
            echo "Target branch is main - create a release tag"
            VERSION_PATTERN="^v([0-9]+)\.([0-9]+)\.([0-9]+)$"
            RELEASE_VERSION=${{ github.event.inputs.release_version }}
            if [[ "$RELEASE_VERSION" =~ $VERSION_PATTERN ]]; then
              echo "Given release version is valid"
            fi
          fi

          echo "Fetching the latest tag"
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")

          echo "Extracting major, minor, patch from the latest tag"
          VERSION_PATTERN="^v([0-9]+)\.([0-9]+)\.([0-9]+)$"
          if [[ "$LATEST_TAG" =~ $VERSION_PATTERN ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            MINOR="${BASH_REMATCH[2]}"
            PATCH="${BASH_REMATCH[3]}"
            PATCH=$((PATCH + 1))
            NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          else
            NEW_VERSION="v0.0.1"
          fi

          if [[ ! "$MAJOR" =~ ^[0-9]+$ ]] || [[ ! "$MINOR" =~ ^[0-9]+$ ]] || [[ ! "$PATCH" =~ ^[0-9]+$ ]]; then
            echo "Error: Version subsequence is not correct"
            exit 1
          else 
            echo "New version $NEW_VERSION"
            echo "RELEASE_VERSION=$NEW_VERSION" >> $GITHUB_ENV
            git tag -a "$RELEASE_VERSION" -m "Release $RELEASE_VERSION"
            git push origin "$RELEASE_VERSION"
          else
            echo "Custom target branch - release tag is not allowed"
          fi
          
      - name: Automate pull request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
